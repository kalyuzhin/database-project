global:
  resolve_timeout: 30s

route:
  receiver: 'tg-bot'
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 30s
  repeat_interval: 30s
  routes:
    - match:
        severity: critical
      receiver: 'tg-bot'
      repeat_interval: 30s

receivers:
- name: 'tg-bot'
  telegram_configs:
  - bot_token: '7852979637:AAH4dcGYipzVSb3fwXZD4jDbcznERBrNREQ'
    chat_id: -1002636823108
    parse_mode: 'HTML'
    message: |
      {{ $alert := index .Alerts 0 }}

      üö® <b>{{ .Status | toUpper }}</b>

      <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–µ–≤–æ–≥–µ:</b>
      üì¢ Type: {{ $alert.Labels.alertname }}
      ‚ö†Ô∏è  Severity: {{ $alert.Labels.severity }}
      üñ•Ô∏è  Host: {{ $alert.Labels.instance }}

      <b>Description:</b>
      {{ $alert.Annotations.summary }}
      üìù {{ $alert.Annotations.description }}

      ‚Äî‚Äî‚Äî
      <b>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é:</b>
      {{- if eq $alert.Labels.alertname "PrometheusDown" }}
      1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Å–µ—Ä–≤–∏—Å prometheus –∑–∞–ø—É—â–µ–Ω:
          <code>systemctl status prometheus</code>
      2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏:
          <code>journalctl -u prometheus</code>
      3Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –¥–æ–∫–µ—Ä-–∫–æ–º–ø–æ—É–∑:
          <code>docker compose down</code>
          <code>docker compose build</code>
          <code>docker compose up -d</code>
      4Ô∏è‚É£ –°–º–æ—Ç—Ä–∏ –ª–æ–≥–∏:
          <code>docker-compose logs</code> 
      {{- else if eq $alert.Labels.alertname "ManyGamesConnections" }}
      1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—å, –∫–∞–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –≤–∏—Å—è—Ç:
          <code>psql -d games -c "select * from pg_stat_activity;"</code>
      2Ô∏è‚É£ –°–≤—è–∂–∏—Å—å —Å DBA, –µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–∞–µ—Ç—Å—è.
      {{- else if eq $alert.Labels.alertname "ManyJamsConnections" }}
      1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ jams:
          <code>psql -d jams -c "select * from pg_stat_activity;"</code>
      {{- else if eq $alert.Labels.alertname "ManyUsersConnections" }}
      1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ users:
          <code>psql -d users -c "select * from pg_stat_activity;"</code>
      {{- else if eq $alert.Labels.alertname "ManyReviewsConnections" }}
      1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ reviews:
          <code>psql -d reviews -c "select * from pg_stat_activity;"</code>
      {{- else if eq $alert.Labels.alertname "LowRating" }}
      1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É.
      2Ô∏è‚É£ –°–≤—è–∂–∏—Å—å —Å –∫–æ–º–∞–Ω–¥–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.
      {{- else if eq $alert.Labels.alertname "FewJamsPresent" }}
      1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –¥–∂–µ–º–æ–≤.
      2Ô∏è‚É£ –°–≤—è–∂–∏—Å—å —Å –∫–æ–º–∞–Ω–¥–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏.
      {{- else }}
      –î–ª—è —ç—Ç–æ–≥–æ –∞–ª–µ—Ä—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ SRE.
      {{- end }}

      üïê –ù–∞—á–∞–ª–æ: {{ $alert.StartsAt }}
      {{ if eq .Status "resolved" }}
      ‚úÖ –†–µ—à–µ–Ω–æ: {{ $alert.EndsAt }}
      {{ end }}

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname']
